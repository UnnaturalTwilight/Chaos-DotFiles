
;; Panels

; User & Power
(defwindow user
  :monitor 0
  :stacking "fg"
  :geometry (geometry :x "40px" :y "40px"
    :width "360px" :height "400px"
  :anchor "top right")
  (profile))

(defwidget profile []
  (box :class "startPanel" :orientation "v" :space-evenly false :spacing -10
    (box :class "picbox" :halign "fill" :valign "start" :space-evenly false :hexpand true :spacing 10
      (image :path "../profilepic.png" :image-width 150)
      (box :orientation "v" :space-evenly false :valign "center" :halign "fill" :spacing 10 :hexpand true :class "hostname"
        (padding :space 10 :vspace 10 :expand true)
        (label :text "${get_env('USER')}@${debug ? "--debug--" : "underkill"}" :halign "start") ;Hard coded cause why not
        (centerbox :hexpand true
          (label :text "ï‡« " :halign "start")
          (label :text "${replace(wifi, ":.*","")} " :halign "center")
          ;; replace with better code later
          (label :text "${replace(wifi, ".*:tailscale0.?*","ðŸ–§")} ${matches(wifi, ".*:.tun.*") ? replace(wifi, ".*:.tun.*","ó°’ƒ") : ""}"  :halign "end")
        )))
    (box :orientation "h" :space-evenly true :class "icons" :halign "center" :valign "end" :spacing 40 :hexpand true
      (tooltip (label :text "Shutdown" :class "tooltip") (button :onrightclick "systemctl poweroff" "ï€‘"))
      (tooltip (label :text "Reboot" :class "tooltip") (button :onrightclick "systemctl reboot" "ï€¡"))
      (tooltip (label :text "Suspend" :class "tooltip") (button :onrightclick "launch-start close && systemctl suspend" "ó°¤„"))
      (tooltip (label :text "Lock" :class "tooltip") (button :onrightclick "launch-start close && loginctl lock-session" "ï€£"))
    )
    (box :class "stat-tiles" :orientation "v" :space-evenly true :valign "end" :class "stat-tiles" :spacing 10
      (tile_batt :status {EWW_BATTERY.BAT1.status} :value {EWW_BATTERY.BAT1.capacity})
      (tile_volume)
    )))

; Time & Date
(defwindow date
  :monitor 0
  :stacking "fg"
  :geometry (geometry :x "40px" :y "40px"
    :width "360px" :height "700px"
  :anchor "bottom right")
  (month))

(defwidget month []
  (box :class "startPanel" :orientation "v" :space-evenly false :vexpand true :valign "fill"
    ; (box :class "calbox" :orientation "v" :space-evenly false :valign "start" :vexpand false
      ; (label :text {formattime(EWW_TIME, "%H:%M:%S" )} :class "clock")
      ; (label :text {formattime(EWW_TIME, "%B %d, %Y" )} :class "local")
      ; (calendar :class "cal"))
    (notifcenter)
    (stats)))

(defwidget stats []
  (box :class "startPanel" :orientation "v" :space-evenly false :spacing -5 :valign "end"
    (box :orientation "v" :space-evenly false :valign "end" :class "stat-tiles" :spacing 10
      (tile_combo)
      (for disk in {mntpoints}
        (tile_disk :char {disk.name ?: disk.mount} :icon {disk.icon} :filesystem {disk.fs} :mountpoint {disk.mount} :device {disk.dev})
      ))
  ))

(defvar brighthover false) (defvar cpuhover false) (defvar ramhover false)

(defwidget tile [?Rclickcmd ?hovervar ?hover]
  (eventbox :class "stat-tile" :onrightclick {Rclickcmd} :hexpand true :timeout 10000
    :onhover {hovervar != "" ? "${EWW_CMD} update HOVER='${jq([HOVER, hovervar], '.[1] as $var | .[0] | fromjson | .[] |= false | .[$var] |= true')}'" : "" }
    :onhoverlost {hovervar != "" ? "${EWW_CMD} update HOVER='${jq([HOVER, hovervar], '.[1] as $var | .[0] | fromjson | .[$var] |= false')}'" : "" }
    (box :orientation "h" :space-evenly false :valign "center" :halign "fill" :spacing 20 :hexpand true
      (children :nth 0) ; icon
      (box :orientation "v" :valign "center" :halign "fill" :class "stat-tile-info" :hexpand true
        (children :nth 1)
        (children :nth 2)
      ))))

(defwidget tile_disk [char icon mountpoint ?filesystem device]
  (tile :hovervar {device} :hover {HOVER?.[device] ?: false}
    :Rclickcmd {matches(device, "\/dev\/sd..") ? "umount ${device} && ${EWW_CMD} poll mntpoints" : "hyprctl notify 0 2000 1 'This is not a removable device.'"}
    (label :class "stat-tile-icon" :text {icon})
    (box :halign "fill" :hexpand true :space-evenly false
      (label :text {char} :halign "start")
      (padding :space 10 :expand true)
      (label :text "${filesystem}" :halign "end"))
    (box :halign "fill" :hexpand true :space-evenly false
      (slider :value {EWW_DISK?.[mountpoint]?.used_perc ?: 0} :visible {HOVER?.[device] != 'null' ? !(HOVER?.[device]) : true })
      (label :text "${formatbytes((EWW_DISK?.[mountpoint]?.used ?: 0), false, 'si')}/${formatbytes((EWW_DISK?.[mountpoint]?.total ?: 0), false, 'si')}"
        :visible {HOVER?.[device] != 'null' ? HOVER?.[device] : false }
      :halign "start")
      (padding :space 0 :expand {HOVER?.[device] != 'null' ? HOVER?.[device] : false })
      (leftpad-label :text {round(EWW_DISK?.[mountpoint]?.used_perc, 0)+"%" ?: "N/A"} :chars 4))
  ))

(defwidget tile_batt [status value]
  (tile
    (label :class "stat-tile-icon" :text {status == 'Charging' ? batt_icons[11] :
      value < 5 ? batt_icons[10] :
      value < 15 ? batt_icons[9] :
      value < 25 ? batt_icons[8] :
      value < 35 ? batt_icons[7] :
      value < 45 ? batt_icons[6] :
      value < 55 ? batt_icons[5] :
      value < 65 ? batt_icons[4] :
      value < 75 ? batt_icons[3] :
      value < 85 ? batt_icons[2] :
      value < 95 ? batt_icons[1] :
    batt_icons[0]})
    (label
      :halign "start" :lines 0 :limit-width 25
      :text {value == 100 ? "Fully Charged" : '${bat_time == '' ? '' : "${replace(bat_time, "minutes", "min")} ${status == 'Charging' ? 'until charged' : 'remaining'}"}'}
    )
    (box :halign "fill" :hexpand true :space-evenly false
      (slider :value {value})
      (leftpad-label :text "${value}%" :chars 5))
  ))

(defwidget tile_volume [] ; hard coded for now, will pull from global var shared with bar later
  (tile
    :Rclickcmd { speaker_raw == "bluez_output.40_72_18_AD_77_86.1" ?
    "pactl set-default-sink alsa_output.pci-0000_00_1f.3.analog-stereo && hyprctl notify 1 2000 1 \"Switched to internal speakers\""
    : "pactl set-default-sink bluez_output.40_72_18_AD_77_86.1 && hyprctl notify 1 2000 1 \"Switched to bluetooth headphones\""}
    (button :onclick "wpctl set-mute @DEFAULT_SINK@ toggle" :class "stat-tile-icon" "${speaker_raw == 'bluez_output.40_72_18_AD_77_86.1' ? 'ó°‹‹' : 'ó°“ƒ'}")
    (box :halign "fill" :hexpand true :space-evenly false
      (label :text {speaker_raw == "bluez_output.40_72_18_AD_77_86.1" ? "JBL TUNE770NC" : "Internal Speakers"} :halign "start")
      (padding :space 10 :expand true)
      (label :text "" :unindent false :halign "start"))
    (box :halign "fill" :hexpand true :space-evenly false
      (slider
        :active true
        :value {volume[0] * 100}
        :onchange "scripts/setvol {}"
      :class {volume[1] == true ? "dull" : "vibrant"})
      (leftpad-label :text "${round(volume[0] * 100, 0)}%" :chars 5))
  ))

(defwidget circlemetric [icon percent ?scrollcmd ?lclickcmd ?rclickcmd ?hovervar ?hover]
  (eventbox :class "circle" :width 80 :height 80 :onscroll {scrollcmd}
    :onhover {hovervar != "" ? "${EWW_CMD} update HOVER='${jq([HOVER, hovervar], '.[1] as $var | .[0] | fromjson | .[] |= false | .[$var] |= true')}'" : "" }
    :onhoverlost {hovervar != "" ? "${EWW_CMD} update HOVER='${jq([HOVER, hovervar], '.[1] as $var | .[0] | fromjson | .[$var] |= false')}'" : "" }
    :onclick {lclickcmd} :onrightclick {rclickcmd}
    (overlay
      (circular-progress :start-at {(37.5)-(percent/2) > -1 ? (37.5)-(percent/2) : 100+(37.5)-(percent/2)} :value {percent}
        :class "circle_stat"
        ; :style ".circle_stat {color: transparentize(#D35D6E, ${((100 - percent )/ 100) * 0.2});}" ; tint the color depending on percent
      :thickness 12)
      (label :text {icon} :class "icons" :visible {hovervar != "" ? !hover : true }) ; replace with svg
      (label :text "${round(percent,0)}%" :visible {hovervar != "" ? hover : false })
    )))

(defwidget tile_combo []
  (eventbox :class "stat-tile" :hexpand true :timeout 10000
    :onhover "${EWW_CMD} update HOVER='${jq([HOVER, 'combo'], '.[1] as $var | .[0] | fromjson | .[] |= false | .[$var] |= true')}'"
    :onhoverlost "${EWW_CMD} update HOVER='${jq([HOVER, 'combo'], '.[1] as $var | .[0] | fromjson | .[$var] |= false')}'"
    (box :orientation "h" :space-evenly false :valign "center" :halign "fill" :spacing 20 :hexpand true
      (box :class "circles"
        (circlemetric :icon "ó°ƒŸ" :percent {round((bright / 96000) * 100, 0)}
          :scrollcmd "scripts/scrollbright {}; ${EWW_CMD} poll bright"
        :hovervar `bright` :hover {HOVER?.bright ?: false}))
      (box :orientation "v" :valign "center" :halign "fill" :class "stat-tile-info" :hexpand true
        (label :text "System Stats" :halign "start")
        (box :halign "fill" :hexpand true :space-evenly false
          (label :text "ï’¼ " :halign "start")
          (slider :value {EWW_CPU.avg})
          (leftpad-label :text "${round(EWW_CPU.avg, 0)}%" :chars 5))
        (box :halign "fill" :hexpand true :space-evenly false
          (label :text "î¿… " :halign "start")
          (slider :value {EWW_RAM.used_mem_perc})
          (leftpad-label :text "${round(EWW_RAM.used_mem_perc, 0)}%" :chars 5))
      )
    )))